<script>

function limpiar(){

    eliminarTabla()
    eliminarTarjetas()
    crearLoader('divcontactos')
}

function mostrar(){

    crearTarjetaContactos()
    eliminarLoader()
}

//Boton subir
window.addEventListener('scroll', function(){

if(this.window.scrollY > 500){
    document.getElementById('botonSubir').style.transform = "scale(1)"
}
if(this.window.scrollY < 500){
    document.getElementById('botonSubir').style.transform = "scale(0)"
}
})
function subirArriba() {

    document.body.scrollTop = 0
    document.documentElement.scrollTop = 0
}

//Cargar Imagen
document.getElementById('imagen').addEventListener("change", function(){
    document.getElementById('imgForm').src = URL.createObjectURL(this.files[0])
})

//INSERTAR CONTACTO
function insertarContacto(){
    
    limpiar()
    //Cerrar modal
    bootstrap.Modal.getInstance(document.getElementById('crearContactoModal')).hide()
    let contacto = guardarDatosContacto()
    let archivo = document.getElementById('imagen').files[0]
    //Si hay archivo guardado
    if(archivo) subirImagen(contacto, archivo)
    else{
        google.script.run
        .withSuccessHandler(contactoInsertadoCorrectamente)
        .withFailureHandler(contactoInsertadoError)
        .insertarContacto(contacto)
    }    
}

function subirImagen(contacto, archivo){

    let fileReader = new FileReader()
    fileReader.readAsArrayBuffer(archivo)
    fileReader.onload = function(){
        let imagen = {
            nombre: archivo.name,
            tipo: archivo.type,
            datos: Array.from(new Int8Array(this.result))

        }
        google.script.run
        .withSuccessHandler(contactoInsertadoCorrectamente)
        .withFailureHandler(contactoInsertadoError)
        .insertarContacto(contacto, imagen)
    }
}

function guardarDatosContacto(){
    //Obtener datos
    let contacto = {
        nombre : document.getElementById('nombre').value,
        apellidos : document.getElementById('apellidos').value,
        correo : document.getElementById('correo').value,
        telefono : document.getElementById('telefono').value,
        imagen : document.getElementById('imgForm').src
    }
    return contacto
}



function contactoInsertadoCorrectamente(){
    //Vaciar datos input
    document.getElementById('nombre').value = ""
    document.getElementById('correo').value = ""
    //Mostrar notificaciones
    crearNotificacionContacto('Contacto creado correctamente', 'Contacto OK')
    mostrar()
    //crearTablaContactos()
}

function contactoInsertadoError(){
    crearNotificacionError('No se ha podido insertar el contacto', 'Error') 
    mostrar()
    //crearTablaContactos()
}
//MODIFICAR CONTACTO
function modificarContacto(numeroFila){

    limpiar()
    //Cerrar modal
    bootstrap.Modal.getInstance(document.getElementById('crearContactoModal')).hide()
    //obtener nuevos DATOS a partir del formulario
    let nombre = document.getElementById('nombre').value
    let apellidos = document.getElementById('apellidos').value
    let correo = document.getElementById('correo').value
    let telefono = document.getElementById('telefono').value    
    crearLoader('divcontactos')
    google.script.run
        .withSuccessHandler(contactoModificadoCorrectamente)
        .withFailureHandler(contactoModificadoError)
        .modificarContacto(numeroFila, {nombre, apellidos, correo, telefono})
}

function contactoModificadoCorrectamente(){
    //Mostrar notificaciones
    crearNotificacionContacto('Contacto modificado correctamente', 'OK')
    mostrar()
    //crearTablaContactos()
}

function contactoModificadoError(){
    //Mostrar notificaciones
    crearNotificacionContacto('No se ha podido modificar el contacto', 'Error') 
    mostrar()
    //crearTablaContactos()
}
//BORRAR CONTACTO
function borrarContacto(numeroFila){

    limpiar()
    google.script.run
        .withSuccessHandler(contactoBorradoCorrectamente)
        .withFailureHandler(contactoBorradoError)
        .borrarContacto(numeroFila)
}

function contactoBorradoCorrectamente(){
    //Mostrar notificaciones
    crearNotificacionOK('Contacto borrado correctamente', 'OK')
    mostrar()
    //crearTablaContactos()
}

function contactoBorradoError(){
    //Mostrar notificaciones
    crearNotificacionError('No se ha podido Borrar el contacto', 'Error') 
    mostrar()
    //crearTablaContactos()
}
//IMPORTAR CONTACTO
function importarContactos(){

    limpiar()
    google.script.run
    .withSuccessHandler(contactosImportadosCorrectamente)
    .withFailureHandler(contactosImportadosError)
    .importarContactos()
}

function contactosImportadosCorrectamente(){

    //Mostrar notificaciones
    crearNotificacionOK('Contactos importados correctamente', 'OK')
    mostrar()
    //crearTablaContactos()
}

function contactosImportadosError(){

    //Mostrar notificaciones
    crearNotificacionError('No se han podido importar contactos', 'Error') 
    mostrar()
    //crearTablaContactos()
}

function mostrarInformacionAdicionalContacto(tarjeta){


}

</script>