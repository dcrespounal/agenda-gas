<script>

function insertarContacto(){
//Obtener datos
let nombre = document.getElementById('nombre').value
let correo = document.getElementById('correo').value
eliminarTabla()
crearLoader('divcontactos')
google.script.run.withSuccessHandler(contactoInsertadoCorrectamente)
.withFailureHandler(contactoInsertadoError)
.insertarContacto(nombre, correo)
}

function contactoInsertadoCorrectamente(){
    //Vaciar datos input
    document.getElementById('nombre').value = ""
    document.getElementById('correo').value = ""
    //Mostrar notificaciones
    crearNotificacionOK('Contacto creado correctamente', 'Contacto OK')
    eliminarLoader()
    crearTablaContactos()
}

function contactoInsertadoError(){
    crearNotificaionError('No se ha podido insertar el contacto', 'Error') 
    eliminarLoader()
    crearTablaContactos()

}

function crearTablaContactos(){

    //Eliminar tabla primero, siempre
    eliminarTabla()
    //crear loader
    crearLoader('divcontactos')

    google.script.run.withSuccessHandler(crearTablaContactosCorrectamente)
    .withFailureHandler(crearTablaContactosError)
    .obtenerContactos()
}

function crearTablaContactosCorrectamente(obj){

    tabla = document.createElement('table')
    tabla.id = 'tablaContactos'
    let tablaHeader = document.createElement('thead')
    let tablaBody = document.createElement('tbody')
    //Metodo for anidado
    //Header de la tabla
    let primeraFila = document.createElement('tr')
    for(let i = 0; i < obj[0].length; i++){
        let celda = document.createElement('td')
        celda.textContent = obj[0][i]
        primeraFila.appendChild(celda)
    }
    tablaHeader.appendChild(primeraFila)
    tabla.appendChild(tablaHeader)

    //Cuerpo de la tabla, no analiza la primera fila
    for(let i = 1; i < obj.length; i++){
        let fila = document.createElement('tr')
        for(let j = 0; j < obj[i].length; j++){
            let celda = document.createElement('td')
            celda.textContent = obj[i][j]
            fila.appendChild(celda)
        }                
        tablaBody.appendChild(fila)                
    }

    //Metodo forEach
    /* Array.from(obj).forEach((filaActual, i) => {
        let fila = document.createElement('tr')
        filaActual.forEach(celdaActual => {
            let celda = document.createElement('td')
            celda.textContent = celdaActual
            fila.appendChild(celda)
        })
        if(i == 0){
            tablaHeader.appendChild(fila)
            tabla.appendChild(tablaHeader)
        }
        else{
            tablaBody.appendChild(fila)
        }                
    }) */

    //Agregar clases a la cabecera de la tabla
    tablaHeader.classList.add('table-dark')
    //Agregar cuerpo a la tabla
    tabla.appendChild(tablaBody)
    //Agregar clases a la tabla
    tabla.classList.add('table', 'table-striped', 'border', 'border-4', 'border-dark','table-success')
    //Agregar tabla a la p치gina
    document.getElementById('divcontactos').appendChild(tabla)
    //Mostrar notificaci칩n satisfactoria
    crearNotificacionOK('Contactos obtenidos correctamente', 'Todo en orden')
    //eliminar icono de carga Loader
    eliminarLoader()
}

function crearTablaContactosError() {
    //mostrar notificaci칩n de error
    crearNotificacionError('No se han obtenido contactos', 'Ocurrio un problema')
    eliminarLoader()

}

function crearNotificacion(mensaje, titulo) {

    document.getElementById('mensajeNotificacion').textContent = mensaje
    document.getElementById('tituloNotificacion').textContent = titulo
    let elementoNotificacion = document.getElementById('notificacion')
    bootstrap.Toast.getOrCreateInstance(elementoNotificacion).show()
}

function crearNotificacionOK(mensaje, titulo){
    crearNotificacion(mensaje, titulo)
    crearIconoNotificacionOK()
    crearColorNotificacion('--color-verde-oscuro')
}

function crearNotificacionError(mensaje, titulo){
    crearNotificacion(mensaje, titulo)
    crearIconoNotificacionError()
    crearColorNotificacion('--color-rojo-oscuro')
}

function crearNotificacionAdvertencia(mensaje, titulo){
    crearNotificacion(mensaje, titulo)
    crearNotificacionAdvertencia()
    crearColorNotificacion('--color-amarillo-oscuro')
}

function crearIconoNotificacionOK(){
    document.getElementById('iconoNotificacion').className = ''
    document.getElementById('iconoNotificacion').classList.add('bi', 'bi-check2-square') 
}

function crearIconoNotificaionError(){
    document.getElementById('iconoNotificacion').className = ''
    document.getElementById('iconoNotificacion').classList.add('bi', 'bi-bug') 
}

function crearIconoNotificaionAdvertencia(){
    document.getElementById('iconoNotificacion').className = ''
    document.getElementById('iconoNotificacion').classList.add('bi', 'bi-exclamation-square')
}

function crearColorNotificacion(color){
    let elementoNotificacion = document.getElementById('notificacion')
    elementoNotificacion.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue(color)
}

function crearNotificacionOLD(tipo, mensaje, titulo) {
    //obtener datos notificacion
    let mensajeNotificacion = document.getElementById('mensajeNotificacion')
    let tituloNotificacion = document.getElementById('tituloNotificacion')
    let elementoNotificacion = document.getElementById('notificacion')
    let iconoNotificacion = document.getElementById('iconoNotificacion')
    let notificacion = bootstrap.Toast.getOrCreateInstance(elementoNotificacion)

    //editar notificacion
    mensajeNotificacion.textContent = mensaje
    tituloNotificacion.textContent = titulo

    switch(tipo){
        case NOTIFICACION_OK:
        iconoNotificacion.className = ''
        iconoNotificacion.classList.add('bi', 'bi-check2-square')    
        elementoNotificacion.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--color-verde-oscuro')
        break

        case NOTIFICACION_DANGER:
        iconoNotificacion.className = ''
        iconoNotificacion.classList.add('bi', 'bi-bug')    
        elementoNotificacion.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--color-rojo-oscuro')
        break

        case NOTIFICACION_WARNING:
        iconoNotificacion.className = ''
        iconoNotificacion.classList.add('bi', 'bi-exclamation-square')    
        elementoNotificacion.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--color-amarillo-oscuro')
        break
    }
    //mostrar notificacion
    notificacion.show();
}

function crearLoader(elementoPadre){
    eliminarLoader()
    let loader = document.createElement('div')
    loader.id = 'loader'
    loader.appendChild(document.createElement('div'))
    loader.appendChild(document.createElement('div'))
    loader.appendChild(document.createElement('div'))
    loader.appendChild(document.createElement('div'))
    loader.classList.add('lds-ring')
    document.getElementById(elementoPadre).appendChild(loader)
}

function eliminarLoader(){
    let loader = document.getElementById('loader')
    if(loader) loader.remove()
}

function eliminarTabla(){
    let tabla = document.getElementById('tablaContactos')
    //comprobar si tabla ya existe para evitar que se vea una nueva tabla a continuaci칩n de la primera
    //siempre se creara una nueva tabla al pulsar el boton
    if (tabla) tabla.remove()
}

</script>